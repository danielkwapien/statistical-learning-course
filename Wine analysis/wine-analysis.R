## ----setup, include=F, echo = F----------------------------------------------------------------------------------------------------------------------------------------------------------
knitr::opts_chunk$set(echo = T, message = F, error = F, fig.align = 'center')


## ---- echo=F-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
htmltools::img(src = knitr::image_uri(file.path("uc3m.jpg")), 
               alt = 'logo', 
               style = 'position:absolute; top:0; right:0; padding:10px;',
               width="600",
               height="80")


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
library(tidyverse)
library(GGally)
library(factoextra)
library(mice)
library(EnvStats)
library(plotly)
library(cluster)
library(MetBrewer)
colors = met.brewer('Benedictus')


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
df_red = read.csv('winequality-red.csv', sep = ';')
glimpse(df_red)


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
sum(is.na(df_red))


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
n_red = nrow(df_red)
for (i in (1:floor(n_red/10))) {
  df_red[sample(c(1:n_red), 1), sample(c(2:ncol(df_red)), 1)] <- NA
  }
sum(is.na(df_red))


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
sum(is.na(df_red$quality))
df_red = df_red[complete.cases(df_red$quality), ]


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
set.seed(42)
mice.obj = mice(df_red, method = 'norm')


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
df_red = mice::complete(mice.obj)


## ---- fig.width=15, fig.height=15--------------------------------------------------------------------------------------------------------------------------------------------------------
par(mfrow= c(3,4))
for(i in seq(from =1, to = 12)){
  boxplot(df_red[,i], las=2, xlab = colnames(df_red)[i], col = colors[1])
}


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
topLimits = c(15,1.5,0.9,10,0.3,60,200,2,4,1.5,14.5)
for(i in seq(from = 1, to = 11)){
    df_red = df_red[df_red[,i] < topLimits[i],]
}



## ----fig.width=15, fig.height=15---------------------------------------------------------------------------------------------------------------------------------------------------------
par(mfrow= c(3,4))
for(i in seq(from =1, to = 12)){
  boxplot(df_red[,i], las=2, xlab = colnames(df_red)[i], col = colors[1])
}


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
quality = df_red$quality
red = df_red[,-c(12)]


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
summary(red)


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
ggcorr(df_red, label = T, label_size = 3, low = colors[1], high = colors[13], midpoint = 0)


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
pca = prcomp(red, scale. = T)
summary(pca)


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
pca$rotation[,1:3]


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data.frame(z1=-pca$x[,1], z2=pca$x[,2]) %>% 
  plot_ly(x=~z1, y=~z2, color = ~quality,  colors = c(colors[13:1]))


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data.frame(z1=-pca$x[,1], z2=pca$x[,2], z3=pca$x[,3]) %>%
  plot_ly(x=~z1, y=~z2, z=~z3, color = ~quality, colors = c(colors[13:1]), size = 4) %>%
  layout(scene = list(xaxis = list(title = 'Dim 1'),
                     yaxis = list(title = 'Dim 2'),
                     zaxis = list(title = 'Dim 3')))


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
fviz_screeplot(pca, addlabels = TRUE, barcolor = colors[13],  barfill = colors[12])


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
par(mfrow= c(3,1))

i=1
fviz_contrib(pca, choice = 'var', axes=i, color = colors[13],  fill = colors[12] )

i=2
fviz_contrib(pca, choice = 'var', axes=i, color = colors[13],  fill = colors[12])

i=3
fviz_contrib(pca, choice = 'var', axes=i, color = colors[13],  fill = colors[12])


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
x.f = factanal(red, factors = 3, rotation='varimax', scores = 'regression')
x.f


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
factor.df = data.frame(quality=quality, x.f$scores) %>% gather('factor', 'score', -quality)

factor.df %>%
  ggplot(aes(x=quality, y=score)) + geom_jitter() +
  theme_bw() + theme(legend.position="bottom") +
  facet_wrap(~factor, ncol=1) +
  labs(title="3-factor model", x="", y="scores", col="")


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
fviz_nbclust(scale(red), kmeans, method = 'wss', linecolor = colors[12])


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
fviz_nbclust(scale(red), kmeans, method = 'silhouette', linecolor = colors[12])


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
set.seed(42)

fit = kmeans(scale(red), centers=2, nstart=100)
groups = fit$cluster


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
barplot(table(groups), col = colors[12])


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
fviz_cluster(fit, data = red, geom = c("point"),ellipse.type = 'norm', pointsize=1)+
  theme_minimal() + scale_colour_manual(values = c(colors[1],colors[13])) + scale_fill_manual(values = c(colors[1], colors[13])) 


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
z1=-pca$x[,1] 
z2=pca$x[,2] 
z3=pca$x[,3]
fig1 = plot_ly(x=~(-z1), y=~z2, marker = list(size = 4), color = ~red$density, colors = c(colors[13:1])) 
fig2 = plot_ly(x=~(-z1), y=~z2, marker = list(size = 4), color = ~red$pH, colors = c(colors[13:1])) 
fig3 = plot_ly(x=~(-z1), y=~z2, marker = list(size = 4), color = ~red$fixed.acidity, colors = c(colors[13:1])) 
fig4 = plot_ly(x=~(-z1), y=~z2, marker = list(size = 4), color = ~red$alcohol, colors = c(colors[13:1])) 
  
annotations = list( 
  list( 
    x = 0.2,  
    y = 1.0,  
    text = "Density",  
    xref = "paper",  
    yref = "paper",  
    xanchor = "center",  
    yanchor = "bottom",  
    showarrow = FALSE 
  ),  
  list( 
    x = 0.8,  
    y = 1,  
    text = "pH",  
    xref = "paper",  
    yref = "paper",  
    xanchor = "center",  
    yanchor = "bottom",  
    showarrow = FALSE 
  ),  
  list( 
    x = 0.2,  
    y = 0.45,  
    text = "Fixed acidity",  
    xref = "paper",  
    yref = "paper",  
    xanchor = "center",  
    yanchor = "bottom",  
    showarrow = FALSE 
  ),
  list( 
    x = 0.8,  
    y = 0.45,  
    text = "Alcohol",  
    xref = "paper",  
    yref = "paper",  
    xanchor = "center",  
    yanchor = "bottom",  
    showarrow = FALSE 
  ))

subplot(fig1, fig2, fig3, fig4, nrows = 2, shareX = T, shareY = T) %>% 
    layout(title = 'Feature comparison', annotations = annotations, showlegend = F)


